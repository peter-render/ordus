unit fArtikel;

interface

uses
  Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms, Dialogs,
  fStdRV, Db, Menus, DBCtrls, StdCtrls, Grids, Wwdbigrd, Wwdbgrid,
  ExtCtrls, wwdblook, Mask, Wwkeycb, FireDAC.Stan.Intf, FireDAC.Stan.Option,
  FireDAC.Stan.Param, FireDAC.Stan.Error,
  FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async,
  FireDAC.DApt, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, Vcl.ImgList;

type
  TfrmArtikel = class(TfrmStdRV)
    wwIncrementalSearch1: TwwIncrementalSearch;
    Label6: TLabel;
    Panel3: TPanel;
    Panel4: TPanel;
    Panel5: TPanel;
    Button2: TButton;
    Button3: TButton;
    Button4: TButton;
    Panel6: TPanel;
    wwDBGrid1: TwwDBGrid;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    Label7: TLabel;
    DBEdit1: TDBEdit;
    DBEdit2: TDBEdit;
    edtYtbehandling: TwwDBLookupCombo;
    edtKund: TwwDBLookupCombo;
    DBEdit3: TDBEdit;
    Button1: TButton;
    DBEdit4: TDBEdit;
    Label8: TLabel;
    Custom_Artikel_Delete: TFDStoredProc;
    sp_Custom_ArtikelGrupp_add: TFDStoredProc;
    qryArtikelgrupp: TFDQuery;
    qryArtikelgruppArtikelnummer: TStringField;
    qryArtikelgruppBeteckning: TStringField;
    qryArtikelgruppAntal: TBCDField;
    qryArtikelgruppLeverantör: TStringField;
    qryArtikelgruppId: TFDAutoIncField;
    qryArtikelgruppArtikelId: TIntegerField;
    qryArtikelgruppUnderartikelId: TIntegerField;
    qryArtikelgruppBorttagen: TSQLTimeStampField;
    dsoArtikelgrupp: TDataSource;
    FDQuery1Id: TFDAutoIncField;
    FDQuery1Artikelnummer: TStringField;
    FDQuery1Beteckning: TStringField;
    FDQuery1YtbehandlingIdDefault: TIntegerField;
    FDQuery1KundID: TIntegerField;
    FDQuery1PDFFinns: TIntegerField;
    FDQuery1PDFFilnamn: TStringField;
    FDQuery1Lagersaldo: TBCDField;
    FDQuery1Lagerplats: TStringField;
    FDQuery1ArtikeltypId: TIntegerField;
    FDQuery1ArtikeltypBeteckning: TStringField;
    FDQuery1ArtikeltypSystemname: TStringField;
    wwDBLookupCombo1: TwwDBLookupCombo;
    Label9: TLabel;
    qryLU_Artikeltyp: TFDQuery;
    qryLU_ArtikeltypId: TIntegerField;
    qryLU_ArtikeltypBeteckning: TStringField;
    qryLU_Kund: TFDQuery;
    qryLU_KundKundnamn: TStringField;
    qryLU_KundKundId: TFDAutoIncField;
    qryLU_KundID: TFDAutoIncField;
    qryLU_KundKortbeteckning: TStringField;
    FDQuery1BockritningFinns: TBooleanField;
    DBCheckBox1: TDBCheckBox;
    DBCheckBox2: TDBCheckBox;
    FDQuery1FixaturFinns: TBooleanField;
    ImageList1: TImageList;
    FDQuery1_YtbehandlingIDdefault: TStringField;
    DBEdit5: TDBEdit;
    DBEdit6: TDBEdit;
    Label10: TLabel;
    qryArtikelgruppFastpris: TCurrencyField;
    procedure btnNyClick(Sender: TObject);
    procedure btnAndraClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure btnBortClick(Sender: TObject);
    procedure Button2Click(Sender: TObject);
    procedure Button3Click(Sender: TObject);
    procedure Button4Click(Sender: TObject);
    procedure btnSparaClick(Sender: TObject);
  private
    procedure btnState;
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmArtikel: TfrmArtikel;

implementation

uses fMain, fritning, Datamodule, fArtikelgrupp, funclib;

{$R *.DFM}

procedure TfrmArtikel.btnState;
begin
  Button2.Enabled := not(datasource1.DataSet.State in [dsedit, dsInsert]);
  Button3.Enabled := Button2.Enabled;
  Button4.Enabled := Button2.Enabled;
  wwDBGrid1.Enabled := Button2.Enabled;
end;

procedure TfrmArtikel.btnBortClick(Sender: TObject);
begin
  // inherited;

  if MessageDlg('Vill du ta bort artikeln?', mtConfirmation, [mbYes, mbNo], 0) = mrYes
  then
    with Custom_Artikel_Delete do
    begin
      ParamByName('@ArtikelId').value := datasource1.DataSet.FieldByName('Id').asInteger;
      execproc;
      if ParamByName('@RETURN_VALUE').value = 0 then
      begin
        with datasource1.DataSet do
        begin
          close;
          open;
        end;
      end;
    end;
end;

procedure TfrmArtikel.btnNyClick(Sender: TObject);
begin
  inherited;
  edtKund.LookupTable.Locate('KundID', 1, []);
  edtKund.text := edtKund.LookupTable.FieldByName('Kundnamn').asString;
  edtKund.setfocus;
  btnState;

end;

procedure TfrmArtikel.btnSparaClick(Sender: TObject);
var
  id: integer;
begin
 fdQuery1.FieldByName('Kundid').Value:= qryLU_Kund.FieldByName('KundID').asInteger;


  inherited;
  id := fdquery1.FieldByName('Id').asInteger;
  dm.qryArtikel.close;
  dm.qryArtikel.open;
  dm.qryArtikel.Locate('ArtikelId', id, []);
  btnState;

end;

procedure TfrmArtikel.Button2Click(Sender: TObject);
begin
  // inherited;
  wwDBGrid1.Enabled := false;

  with TfrmArtikelgrupp.create(Application) do
  begin
    caption := 'Lägg till artikel till artikelgruppen';

    with qryLU_artikel do
    begin
      close;
      ParamByName('Id').value := datasource1.DataSet.FieldByName('Id')
        .asInteger;
      open;
    end;

    qryArtikelgrupp.Append;
    // qryArtikelgrupp.Fieldbyname('ArtikelId').asInteger := dm.qryArtikelArtikelId.AsInteger;
    Showmodal;

    if modalresult = mrOK then
    begin

      with sp_Custom_ArtikelGrupp_add do
      begin
        ParamByName('@ArtikelId').value := datasource1.DataSet.FieldByName
          ('Id').asInteger;
        ParamByName('@UnderartikelId').value :=
          qryArtikelgrupp.FieldByName('UnderartikelId').asInteger;
        ParamByName('@Antal').value := qryArtikelgrupp.FieldByName
          ('Antal').Asfloat;
        ParamByName('@Leverantör').value := qryArtikelgrupp.FieldByName
          ('Leverantör').asString;
        execproc;

      end;
      qryArtikelgrupp.Cancel;

      requery(qryArtikelgrupp);
      wwDBGrid1.Enabled := true;;
    end
    else
      qryArtikelgrupp.Cancel;

  end;
  btnState;

end;

procedure TfrmArtikel.Button3Click(Sender: TObject);
begin

  // qryArtikelgrupp.Fieldbyname('ArtikelId').asInteger := frmmain.qryArtikel.FieldByName('ArtikelId').asInteger;

  with TfrmArtikelgrupp.create(Application) do
  begin

    caption := 'Ändra artikel i artikelgruppen';

    Showmodal;

    wwDBLookupCombo1.Enabled := false;
    qryArtikelgrupp.Edit;

    if modalresult = mrOK then
    begin
      qryArtikelgrupp.post;
      requery(qryArtikelgrupp);
    end
    else
      qryArtikelgrupp.Cancel;
  end;

end;

procedure TfrmArtikel.Button4Click(Sender: TObject);
begin
  if MessageDlg('Vill du ta bort artiklen från artikelgruppen?', mtConfirmation,
    [mbYes, mbNo], 0) = mrYes then
    with qryArtikelgrupp do
    begin
      Edit;
      FieldByName('Borttagen').AsDateTime := date;
      post;
      requery(qryArtikelgrupp);
    end;
  btnState;

end;

procedure TfrmArtikel.btnAndraClick(Sender: TObject);
begin
  inherited;
  edtKund.setfocus;
  btnState;

end;

procedure TfrmArtikel.FormShow(Sender: TObject);
begin
  inherited;

  edtKund.LookupTable.open;
  edtYtbehandling.LookupTable.open;
  qryArtikelgrupp.open;
  qryLU_Artikeltyp.open;
  btnState;

end;

end.
